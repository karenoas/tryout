<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Popup</title>
    <style>
        /* Estilos para el botón de abrir el chat */
        .chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Estilos para el contenedor del chat emergente */
        .chat-popup {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 300px;
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            box-shadow: 0px 5px 10px rgba(0, 0, 0, 0.2);
            z-index: 9999;
        }

        /* Estilos para el encabezado del chat */
        .chat-popup-header {
            background-color: #007bff;
            color: #fff;
            padding: 10px;
            text-align: center;
        }

        /* Estilos para el contenido del chat */
        .chat-popup-content {
            padding: 10px;
        }

        /* Estilos para el formulario del chat */
        .chat-popup-form {
            display: flex;
            flex-direction: column;
        }

        /* Estilos para el campo de entrada de texto */
        .chat-popup-input {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Estilos para el botón de enviar */
        .chat-popup-send-btn {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- Botón para abrir el chat -->
    <button class="chat-btn" onclick="toggleChat()">Chat</button>

    <!-- Contenedor del chat emergente -->
    <div class="chat-popup" id="chatPopup">
        <div class="chat-popup-header">
            Chat
            <span style="float:right; cursor:pointer;" onclick="toggleChat()">X</span>
        </div>
        <div class="chat-popup-content">
            <ul id="message-list"></ul>
            <form class="chat-popup-form" onsubmit="enviarMensaje(); return false;">
                <input type="text" id="message-input" class="chat-popup-input" placeholder="Escribe tu mensaje aquí..." onkeypress="handleKeyPress(event)" required>
                <button type="submit" class="chat-popup-send-btn">Enviar</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
    <script>

      // Variables globales
      var socket = io({ transports: ["polling"] });
      var username = localStorage.getItem("currentUsername");
      var messages = JSON.parse(localStorage.getItem("messages")) || [];

      // Función para mostrar un mensaje en el chat
      function mostrarMensaje(usuario, mensaje) {
        var messageList = document.getElementById("message-list");
        var li = document.createElement("li");
        li.textContent = "(" + usuario + "): " + mensaje;
        messageList.appendChild(li);
      }

      // Función para enviar un mensaje
      function enviarMensaje() {
        var mensajeInput = document.getElementById("message-input");
        var mensaje = mensajeInput.value.trim();

        if (mensaje !== "") {
          // Verificar si el mensaje es un comando para establecer un icono
          if (mensaje.startsWith("/seticon")) {
            // Extraer el nombre de usuario y el nombre del icono del comando
            var comando = mensaje.split(" ");
            var usuarioConIcono = comando[1];
            var icono = comando[2];

            // Actualizar el icono del usuario en users.json
            if (icono) {
              actualizarInfoUsuario(usuarioConIcono, icono);
            }
          } else {
            // Obtener el nombre de usuario actual
            var username = localStorage.getItem("currentUsername");

            // Obtener la información del usuario
            var userInfo = obtenerInfoUsuario(username);

            // Enviar mensaje al servidor con el nombre de usuario correcto y el icono, si está definido
            socket.emit("mensaje", { usuario: username, mensaje: mensaje, icono: userInfo ? userInfo.icono : null });
          }

          mensajeInput.value = "";
        }
      }


      // Función para alternar la visibilidad del chat emergente
      function toggleChat() {
          var chatPopup = document.getElementById('chatPopup');
          chatPopup.style.display = chatPopup.style.display === 'none' ? 'block' : 'none';
      }

      // Escuchar eventos del servidor
      socket.on("nuevoMensaje", function (data) {
        mostrarMensaje(data.usuario, data.mensaje);
      });

      socket.on("cargarMensajes", function (data) {
        messages = data.messages || [];
        cargarMensajes("message-list");
      });

      // Cargar mensajes al iniciar el chat
      socket.emit("cargarMensajes");

      // Función para manejar la tecla Enter
      function handleKeyPress(event) {
        if (event.keyCode === 13) { // 13 es el código de la tecla "Enter"
          enviarMensaje();
        }
      }

      // Función para cargar los mensajes en la lista del chat
      function cargarMensajes(lista) {
        var messageList = document.getElementById(lista);
        messageList.innerHTML = "";

        messages.forEach(function (message) {
          mostrarMensaje(message.usuario, message.mensaje);
        });
      }
      function obtenerInfoUsuario(username) {
        var users = JSON.parse(localStorage.getItem("users")) || [];
        return users.find(user => user.username === username);
      }

      // Función para actualizar la información del usuario en el almacenamiento local
      function actualizarInfoUsuario(username, icono) {
        var users = JSON.parse(localStorage.getItem("users")) || [];
        var index = users.findIndex(user => user.username === username);
        if (index !== -1) {
          users[index].icono = icono;
          localStorage.setItem("users", JSON.stringify(users));
        }
      }

    </script>
</body>
</html>
